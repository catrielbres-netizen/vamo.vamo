rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rides/{rideId} {
      // Un pasajero autenticado puede crear un viaje si el passengerId es el suyo.
      allow create: if request.auth != null && request.resource.data.passengerId == request.auth.uid;
      
      // Se permite listar viajes si:
      // 1. Es un conductor buscando viajes disponibles ('searching_driver').
      // 2. Es un pasajero consultando su propio historial de viajes (status 'finished' o 'cancelled').
      allow list: if request.auth != null && 
                    (request.query.get("status") == "searching_driver" || 
                     (request.query.get("passengerId") == request.auth.uid && 
                      (request.query.get("status") == "finished" || request.query.get("status") == "cancelled")));

      // El pasajero del viaje o el conductor asignado pueden leer el documento.
      // También se permite leer si el estado es 'searching_driver' para que los conductores vean detalles.
      allow read: if request.auth != null && 
                   (resource.data.passengerId == request.auth.uid || 
                    resource.data.driverId == request.auth.uid ||
                    resource.data.status == 'searching_driver');

      // Se puede actualizar un viaje si:
      // 1. El que actualiza es el pasajero y está cancelando el viaje.
      // 2. El que actualiza es un conductor asignándose a un viaje que estaba buscando conductor.
      // 3. El que actualiza ya es el conductor asignado a este viaje.
      allow update: if request.auth != null && 
                     ((resource.data.passengerId == request.auth.uid && request.resource.data.status == 'cancelled') ||
                      (resource.data.status == 'searching_driver' && request.resource.data.driverId == request.auth.uid) ||
                      (resource.data.driverId == request.auth.uid));

      // Nadie puede eliminar viajes, solo se cancelan o finalizan.
      allow delete: if false;
    }
  }
}
