rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rides/{rideId} {
      // Un pasajero autenticado puede crear un viaje.
      // El nuevo recurso debe tener el ID del pasajero correcto.
      allow create: if request.auth != null && request.resource.data.passengerId == request.auth.uid;
      
      // Un usuario puede listar viajes si:
      // 1. Es un conductor buscando viajes disponibles ('searching_driver').
      // 2. Es un pasajero consultando su propio historial de viajes.
      allow list: if request.auth != null && 
                    ((request.query.get("status") == "searching_driver") || 
                     (request.query.get("passengerId") == request.auth.uid));

      // El pasajero del viaje o el conductor asignado pueden leer el documento.
      // También se permite leer si el estado es 'searching_driver' para que los conductores vean detalles.
      allow read: if request.auth != null && 
                   (resource.data.passengerId == request.auth.uid || 
                    resource.data.driverId == request.auth.uid ||
                    resource.data.status == 'searching_driver');

      // El pasajero puede cancelar su propio viaje si aún no ha comenzado.
      // El conductor asignado puede actualizar el estado del viaje.
      allow update: if request.auth != null && 
                     ((resource.data.passengerId == request.auth.uid && request.resource.data.status == 'cancelled') || 
                      (resource.data.driverId == request.auth.uid));

      // Nadie puede eliminar viajes, solo se cancelan o finalizan.
      allow delete: if false;
    }
  }
}
