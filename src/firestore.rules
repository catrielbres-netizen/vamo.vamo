
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isDriver(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'driver';
    }
    
    function isApprovedDriver(userId) {
      let user = get(/databases/$(database)/documents/users/$(userId)).data;
      return user.role == 'driver' && user.approved == true && user.isSuspended != true;
    }

    function isAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

    // Perfiles de usuario
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin(request.auth.uid);
    }
    
    // Resúmenes semanales de conductores
    match /driver_summaries/{summaryId} {
      allow read, write: if isAdmin(request.auth.uid);
      allow read: if request.auth.uid == resource.data.driverId;
      allow create, update: if request.auth.uid == request.resource.data.driverId;
    }
    
    // Logs de Auditoría (solo admins)
    match /auditLogs/{logId} {
      allow read, write: if isAdmin(request.auth.uid);
    }

    // Viajes
    match /rides/{rideId} {
      // 1. Un pasajero puede crear un viaje para sí mismo.
      allow create: if request.auth.uid == request.resource.data.passengerId;

      // 2. Un viaje puede ser leído por:
      //    - El pasajero o el conductor asignado.
      //    - Un conductor aprobado si el viaje está buscando conductor (ESTA ES LA REGLA CLAVE)
      allow read: if request.auth != null && (
          (resource.data.passengerId == request.auth.uid || resource.data.driverId == request.auth.uid) ||
          (isApprovedDriver(request.auth.uid) && resource.data.status == 'searching_driver')
      );
      
      // 3. Un viaje puede ser actualizado por:
      //    - El pasajero (para cancelar).
      //    - Un conductor aprobado (para aceptar el viaje).
      //    - El conductor ya asignado (para cambiar el estado a 'llegó', 'en curso', etc.).
      allow update: if request.auth != null && (
        resource.data.passengerId == request.auth.uid ||
        resource.data.driverId == request.auth.uid ||
        (isApprovedDriver(request.auth.uid) && request.resource.data.driverId == request.auth.uid)
      );
    }

    // Transacciones de plataforma
    match /platform_transactions/{transactionId} {
        allow read: if request.auth.uid == resource.data.driverId || isAdmin(request.auth.uid);
        allow create: if isAdmin(request.auth.uid); // Solo admin puede crear ajustes
    }

    // Intenciones de pago (para Mercado Pago)
    match /payment_intents/{intentId} {
        allow read: if request.auth.uid == resource.data.driverId || isAdmin(request.auth.uid);
        // La creación la hace el server action, por lo que no necesita regla de cliente
    }

  }
}
