rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for authenticated users
    function isAuthenticated() {
      return request.auth != null;
    }

    // --- USERS ---
    match /users/{userId} {
      // Any authenticated user can create their own profile
      allow create: if isAuthenticated();

      // Users can only read/update/delete their own profile
      // Admins can do anything
      allow read, update, delete: if isAuthenticated() && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // --- RIDES ---
    match /rides/{rideId} {
      // Any authenticated user can list the collection for querying
      allow list: if isAuthenticated();

      // Any authenticated user can create a ride
      allow create: if isAuthenticated();

      // Only the passenger, the assigned driver, or an admin can read or update a ride
      allow get, update: if isAuthenticated() && (
        request.auth.uid == resource.data.passengerId ||
        request.auth.uid == resource.data.driverId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      // Deletes are disallowed for now to preserve ride history
      allow delete: if false;
    }

    // --- DRIVER SUMMARIES ---
    match /driver_summaries/{summaryId} {
        // Drivers can read their own summaries, Admins can read any summary
        allow get: if isAuthenticated() && (
            resource.data.driverId == request.auth.uid ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        );

        // Allow listing for admins
        allow list: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

        // Creation/updates can be done by the system (or any authenticated user for now)
        allow create, update: if isAuthenticated();
    }
    
    // --- AUDIT LOGS ---
    match /auditLogs/{logId} {
       // Only admins can read or write audit logs
      allow read, write: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
